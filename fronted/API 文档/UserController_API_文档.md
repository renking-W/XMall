# UserController API 接口文档

## 项目信息
- **基础路径**: `/user`
- **Controller**: `com.renking.xmall.Controller.UserController`
- **说明**: 用户模块相关接口，包括登录、注册、信息查询和修改等功能

---

## 接口列表

### 1. 密码登录接口

**接口名称**: 用户密码登录

**请求方式**: `POST`

**请求路径**: `/user/login/password`

**功能说明**: 使用手机号和密码进行登录，仅限已有账户的用户

**请求参数**:
| 参数名 | 参数类型 | 是否必要 | 说明 |
|--------|--------|--------|------|
| phone | String | 是 | 用户手机号 |
| password | String | 是 | 用户密码 |

**请求示例**:
```json
{
  "phone": "13800138000",
  "password": "123456"
}
```

**响应成功** (HTTP 200):
```json
{
  "code": 20000,
  "message": "登录成功",
  "data": {
    "id": 1,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userName": "test_user",
    "phone": "13800138000",
    "password": null,
    "oldPassword": null,
    "code": null
  }
}
```

**响应失败** (HTTP 200):
```json
{
  "code": 20501,
  "message": "用户不存在或密码错误",
  "data": null
}
```

**状态码说明**:
| 状态码 | 含义 |
|--------|------|
| 20000 | 请求成功 |
| 20501 | 用户不存在或密码错误 |

**后续使用**: 返回的 `token` 需要在请求头中携带用于身份认证

---

### 2. 获取验证码接口

**接口名称**: 获取短信验证码

**请求方式**: `GET`

**请求路径**: `/user/code/{phone}`

**功能说明**: 根据手机号生成6位随机验证码，并存储在 Redis 中，有效期为配置时间

**请求参数**:
| 参数名 | 参数类型 | 位置 | 是否必要 | 说明 |
|--------|--------|------|--------|------|
| phone | String | URL 路径 | 是 | 用户手机号 |

**请求示例**:
```
GET /user/code/13800138000
```

**响应成功** (HTTP 200):
```json
{
  "code": 20000,
  "message": "获取验证码成功:123456",
  "data": "获取验证码成功:123456"
}
```

**状态码说明**:
| 状态码 | 含义 |
|--------|------|
| 20000 | 验证码生成成功 |

**重要提示**: 
- 返回的验证码为6位数字
- 验证码存储在 Redis 中，有效期为 10 分钟（根据配置）
- 该接口返回验证码仅用于开发测试，生产环境应通过短信服务发送

---

### 3. 验证码登录/注册接口

**接口名称**: 验证码登录（自动创建新账户）

**请求方式**: `POST`

**请求路径**: `/user/login/code`

**功能说明**: 使用手机号和验证码进行登录，如果用户不存在则自动创建新账户

**请求参数**:
| 参数名 | 参数类型 | 是否必要 | 说明 |
|--------|--------|--------|------|
| phone | String | 是 | 用户手机号 |
| code | String | 是 | 验证码（6位数字） |

**请求示例**:
```json
{
  "phone": "13800138000",
  "code": "123456"
}
```

**响应成功** (HTTP 200):
```json
{
  "code": 20000,
  "message": "登录成功",
  "data": {
    "id": 1,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userName": "13800138000",
    "phone": "13800138000",
    "password": null,
    "oldPassword": null,
    "code": null
  }
}
```

**响应失败 - 验证码无效** (HTTP 200):
```json
{
  "code": 20503,
  "message": "无效的验证码",
  "data": null
}
```

**状态码说明**:
| 状态码 | 含义 |
|--------|------|
| 20000 | 登录/注册成功 |
| 20503 | 验证码无效或已过期 |
| 50000 | 插入数据失败 |

**业务逻辑**:
1. 验证 Redis 中存储的验证码是否存在且有效
2. 如果验证码有效：
   - 新用户：自动创建账户，用户名默认为手机号
   - 已有用户：直接登录
3. 登录成功后生成 token 并存储在 Redis 中
4. 有效期为 8 小时

---

### 4. 获取用户信息接口

**接口名称**: 获取用户信息

**请求方式**: `POST`

**请求路径**: `/user/info`

**功能说明**: 根据用户名获取完整的用户信息，支持 Redis 缓存（8小时有效期）

**请求参数**:
| 参数名 | 参数类型 | 是否必要 | 说明 |
|--------|--------|--------|------|
| userName | String | 是 | 用户名 |
| phone | String | 否 | 用户手机号（用于生成缓存 key） |

**请求示例**:
```json
{
  "userName": "test_user",
  "phone": "13800138000"
}
```

**响应成功** (HTTP 200):
```json
{
  "code": 20000,
  "message": "获取用户信息成功",
  "data": {
    "id": 1,
    "token": null,
    "userName": "test_user",
    "phone": "13800138000",
    "password": null,
    "oldPassword": null,
    "code": null
  }
}
```

**状态码说明**:
| 状态码 | 含义 |
|--------|------|
| 20000 | 获取成功 |
| 50001 | 数据解析失败 |

**缓存策略**:
- 首次查询从数据库获取，然后存入 Redis 缓存
- 后续查询优先从 Redis 缓存获取
- 缓存有效期：8 小时
- 当用户信息被修改时，缓存会被清除

---

### 5. 修改用户信息接口

**接口名称**: 修改用户信息

**请求方式**: `POST`

**请求路径**: `/user/update`

**功能说明**: 修改用户信息（包括密码等），需要验证旧密码

**请求参数**:
| 参数名 | 参数类型 | 是否必要 | 说明 |
|--------|--------|--------|------|
| id | Long | 否 | 用户 ID（会被覆盖） |
| userName | String | 是 | 用户名（用于查询当前用户信息） |
| phone | String | 是 | 手机号（用于查询和更新） |
| password | String | 否 | 新密码 |
| oldPassword | String | 是 | 旧密码（用于验证） |

**请求示例**:
```json
{
  "userName": "test_user",
  "phone": "13800138000",
  "password": "654321",
  "oldPassword": "123456"
}
```

**响应成功** (HTTP 200):
```json
{
  "code": 20000,
  "message": "修改用户信息成功",
  "data": true
}
```

**响应失败 - 用户不存在** (HTTP 200):
```json
{
  "code": 20501,
  "message": "用户不存在",
  "data": false
}
```

**响应失败 - 密码错误** (HTTP 200):
```json
{
  "code": 20504,
  "message": "密码不一致或密码错误！",
  "data": null
}
```

**状态码说明**:
| 状态码 | 含义 |
|--------|------|
| 20000 | 修改成功 |
| 20501 | 用户不存在 |
| 20504 | 旧密码错误 |

**业务逻辑**:
1. 先获取当前用户的信息（会从数据库或缓存获取）
2. 验证提供的旧密码是否与数据库中的密码一致
3. 如果密码验证通过，更新用户信息到数据库
4. 清除该用户的缓存数据（下次查询时重新从数据库读取）

**注意事项**:
- oldPassword 为必填项，用于验证用户身份
- 修改后缓存会被清除，确保数据一致性
- 建议在生产环境中通过 Token 来验证用户身份，而不是依赖 userName

---

## 通用说明

### 响应格式
所有接口返回 JSON 格式，统一响应结构如下：
```json
{
  "code": 20000,
  "message": "操作提示信息",
  "data": {}
}
```

### 状态码汇总
| 状态码 | 含义 | 说明 |
|--------|------|------|
| 20000 | SUCCESS | 操作成功 |
| 20501 | USER_NOT_EXIST | 用户不存在 |
| 20502 | TOKEN_INVALID | Token 无效 |
| 20503 | CODE_UNVALID | 验证码无效 |
| 20504 | USER_PASSWORD_ERROR | 用户密码错误 |
| 50001 | DATA_PARSE_ERROR | 数据解析失败 |

### 关键实体类说明

**UserDto** (用户数据传输对象):
- `id`: 用户唯一标识
- `token`: 登录凭证，后续请求需在请求头中携带
- `userName`: 用户名
- `phone`: 手机号
- `password`: 密码（登录时返回为 null）
- `oldPassword`: 旧密码（仅在修改密码时使用）
- `code`: 验证码（仅在验证码登录时使用）

**Result<T>** (统一响应体):
- `data`: 响应数据（泛型）
- `message`: 响应消息
- `code`: 响应状态码

### 缓存策略
- **验证码缓存**: Redis Key = `user:code:{phone}`，有效期 10 分钟
- **用户信息缓存**: Redis Key = `user:info:{phone}`，有效期 8 小时
- **Token 缓存**: Redis Key = `user:token:{phone}`，有效期 8 小时

### 异常处理
- 所有异常都会被 `GlobalExceptionHandler` 捕获并返回统一格式的响应
- 业务异常会抛出 `ServiceException`，包含状态码和错误信息

### Token 管理
- Token 通过 JWT 生成，包含用户 ID 和手机号等信息
- 登录和注册成功后返回 Token
- Token 存储在 Redis 中，便于权限验证和其他业务使用
- 后续请求应在请求头中携带 Token，格式为: `Authorization: {token}`

---

## 使用建议

### 登录流程
1. **密码登录**: 
   - 直接调用 `/user/login/password` 接口
   - 适合已有账户的用户

2. **验证码登录**:
   - 首先调用 `/user/code/{phone}` 获取验证码
   - 然后调用 `/user/login/code` 进行登录或注册
   - 适合新用户注册或无密码登录

### 用户信息管理
1. **查询用户信息**: 调用 `/user/info` 接口
2. **修改用户信息**: 调用 `/user/update` 接口
3. 修改后自动清除缓存，确保数据一致性

### 安全建议
1. 生产环境不应直接返回验证码给用户，应通过短信/邮件发送
2. 密码应在传输时加密，不应以明文存储
3. Token 有效期应根据业务需求设置
4. 建议为接口添加速率限制，防止暴力破解

